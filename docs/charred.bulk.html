<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>charred.bulk documentation</title><script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XJYNJF48RM"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XJYNJF48RM');</script><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Charred</span> <span class="project-version">1.036</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>charred</span></div></div></li><li class="depth-2 branch"><a href="charred.api.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>api</span></div></a></li><li class="depth-2 branch current"><a href="charred.bulk.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bulk</span></div></a></li><li class="depth-2 branch"><a href="charred.coerce.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>coerce</span></div></a></li><li class="depth-2"><a href="charred.parallel.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>parallel</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="charred.bulk.html#var-batch-csv-rows"><div class="inner"><span>batch-csv-rows</span></div></a></li><li class="depth-1"><a href="charred.bulk.html#var-cat-csv-inputs"><div class="inner"><span>cat-csv-inputs</span></div></a></li><li class="depth-1"><a href="charred.bulk.html#var-concatenate-csv"><div class="inner"><span>concatenate-csv</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">charred.bulk</h1><div class="doc"><div class="markdown"><p>Helpers for bulk operations such as concatenating a large sequence of csv files.</p>
</div></div><div class="public anchor" id="var-batch-csv-rows"><h3>batch-csv-rows</h3><div class="usage"><code>(batch-csv-rows batch-size row-seq)</code><code>(batch-csv-rows batch-size options row-seq)</code></div><div class="doc"><div class="markdown"><p>Given a potentially very large sequence of rows, lazily return batches of rows.
Returned object has an efficient iterator, IReduceInit (3 arg reduce) implementations
and an efficient seq (safest) implementation.  <strong>When using raw iterator, each previous batch must be completely
read before the .hasNext function of the iterator will return an accurate result.</strong></p>
<p>If <code>:csv-load-thread-name</code> is provided then the loading will happen in a separate
thread and an auto-closeable seq will be returned that is safe to use in pmap or similar
operations.  This allows the CSV system to run at full speed while potentially cpu-intensive
processing can happen in other threads.  Recommended batch sizes for this pathway are
around 128000.  The loading can be stopped prematurely by closing the returned value
<em>and</em> reading the entirety of the sequence.</p>
<p>Options:</p>
<ul>
<li><code>:header?</code> - When true, the header row will be returned as the first row
of each batch.  Defaults to true.</li>
<li><code>:csv-load-thread-name</code> - When not nil, perform the csv parsing in a separate
thread named <code>:csv-load-thread-name</code>.</li>
<li><code>:csv-load-queue-depth</code> - Queue depth used for each batch of rows.  Defaults to 4.</li>
<li><code>:csv-load-queue-timeout</code> - Timeout in milliseconds used for .put calls.  Defaults
to 5 seconds.</li>
<li><code>:csv-load-log-level</code> - Defaults to <code>:debug</code>.  Options are <code>:debug</code> or <code>:info</code>.</li>
</ul>
<p>Examples:</p>
<pre><code class="language-clojure">;; HANGS - each batch is not read entirely before .next call of iterator so iterator forever
;; has next.
user&gt; (-&gt;&gt; (charred/read-csv-supplier (java.io.File. "stocks.csv"))
           (bulk/batch-csv-rows 100)
           (vec))
;; Works - the seq implementation is always safe
user&gt; (-&gt;&gt; (charred/read-csv-supplier (java.io.File. "stocks.csv"))
           (bulk/batch-csv-rows 100)
           (seq)
           (vec))
;; Works fine -
user&gt; (-&gt;&gt; (charred/read-csv-supplier (java.io.File. "stocks.csv"))
           (bulk/batch-csv-rows 100)
           (map vec))

;; Very memory efficient -
user&gt; (-&gt;&gt; (charred/read-csv-supplier (java.io.File. "stocks.csv"))
           (bulk/batch-csv-rows 100)
           (reduce (fn [rc batch] (+ rc (count (vec batch))))
                   0))
;; Threaded example - note the batch is already a vector
user&gt; (-&gt;&gt; (charred/read-csv-supplier (java.io.File. "stocks.csv"))
           (bulk/batch-csv-rows 100 {:csv-load-thread-name "CSV loader" :csv-load-log-level :info})
           (reduce (fn [rc batch] (+ rc (count batch)))
                   0))
Aug 19, 2023 9:19:43 AM charred.bulk$batch_csv_rows$fn__6468 invoke
INFO: CSV load thread finished - 566 rows read
Aug 19, 2023 9:19:43 AM charred.bulk$batch_csv_rows$reify__6472 close
INFO: CSV load thread joined
566
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/charred/bulk.clj#L90">view source</a></div></div><div class="public anchor" id="var-cat-csv-inputs"><h3>cat-csv-inputs</h3><div class="usage"><code>(cat-csv-inputs)</code><code>(cat-csv-inputs options)</code></div><div class="doc"><div class="markdown"><p>Stateful transducer that, given a sequence of inputs, produces a single sequence
of parsed csv rows.  This transducer slices off the header rows of downstream
inputs when <code>:header?</code> is true.</p>
<p>Options:</p>
<ul>
<li><code>:header?</code> - defaults to true - assume first row of each file is a header row.</li>
</ul>
<p>Options are passed through to read-csv-supplier.</p>
<p>Example:</p>
<pre><code class="language-clojure">(transduce (comp (bulk/cat-csv-inputs options) (map tfn)) (charred/write-csv-rf options) fseq)
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/charred/bulk.clj#L11">view source</a></div></div><div class="public anchor" id="var-concatenate-csv"><h3>concatenate-csv</h3><div class="usage"><code>(concatenate-csv output fseq)</code><code>(concatenate-csv output options fseq)</code></div><div class="doc"><div class="markdown"><p>Given a sequence of csv files, concatenate into a single csv file.</p>
<ul>
<li>fseq - a sequence of java.io.File's or other inputs to read-csv-supplier</li>
<li>output - an output stream or other closeable stream.</li>
</ul>
<p>Returns the number of rows written.</p>
<p>Options:</p>
<ul>
<li><code>:header?</code> - defaults to true - assume first row of each file is a reader row.</li>
<li><code>:tfn</code> - function from row-&gt;row that receives all output rows (header rows, aside from the first
are elided).  If this function returns 'nil' that row is then elided from output.</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">user&gt; (-&gt;&gt; (repeat 10 (java.io.File. "/home/chrisn/dev/tech.all/tech.ml.dataset/test/data/stocks.csv"))
           (bulk/concatenate-csv "test/data/big-stocks.csv" {:header? false}))
5610
user&gt; (-&gt;&gt; (repeat 10 (java.io.File. "/home/chrisn/dev/tech.all/tech.ml.dataset/test/data/stocks.csv"))
           (bulk/concatenate-csv "test/data/big-stocks.csv" {:header? true}))
5601
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/charred/bulk.clj#L237">view source</a></div></div></div></body></html>